#include <iostream>
#include <vector>
#include <string>
#include <chrono>     // Thư viện đo thời gian
#include <iomanip>    // Thư viện định dạng in ấn (std::fixed, std::setprecision)
#include <filesystem> // C++17: Để kiểm tra thư mục models

#include "../../include/dataset.h"
#include "../../include/autoencoder.h"

// --- 1. SET HYPERPARAMETERS [cite: 262] ---
const int BATCH_SIZE = 32;
const int EPOCHS = 20;
const float LEARNING_RATE = 0.001f;

int main()
{
    // Tạo thư mục models nếu chưa có
    if (!std::filesystem::exists("models"))
    {
        std::filesystem::create_directory("models");
    }

     // --- 2. DATA LOADING & PREPROCESSING [cite: 237-245] ---
    std::cout << "Phase 1: CPU Baseline Implementation" << std::endl;
    std::cout << "------------------------------------" << std::endl;
    std::cout << "[1/4] Loading CIFAR-10 Dataset..." << std::endl;

    CIFAR10Dataset dataset;
    // Lưu ý: Đảm bảo thư mục 'data' chứa các file .bin nằm cùng cấp với file thực thi hoặc điều chỉnh đường dẫn
    dataset.load_train("data");

    if (dataset.train_images.empty())
    {
        std::cerr << "Error: No training data loaded! Please check 'data' folder path." << std::endl;
        return 1;
    }

     // --- 3. MODEL INITIALIZATION [cite: 254-255] ---
        std::cout
        << "[2/4] Initializing Autoencoder Architecture..." << std::endl;
    Autoencoder model;

    std::cout << "      Hyperparameters: Batch=" << BATCH_SIZE
              << ", Epochs=" << EPOCHS
              << ", LR=" << LEARNING_RATE << std::endl;

     // --- 4. TRAINING LOOP [cite: 263-267] ---
        std::cout
        << "[3/4] Starting Training Loop..." << std::endl;
    std::cout << "------------------------------------------------------------" << std::endl;
    std::cout << "| Epoch |   Avg Loss   |  Time (s)  |  Images/Sec |" << std::endl;
    std::cout << "------------------------------------------------------------" << std::endl;

    for (int epoch = 0; epoch < EPOCHS; ++epoch)
    {
        // Bắt đầu bấm giờ cho Epoch
        auto start_time = std::chrono::high_resolution_clock::now();

         // [QUAN TRỌNG] Xáo trộn dữ liệu đầu mỗi epoch [cite: 244]
            dataset.shuffle_data();

        float total_epoch_loss = 0.0f;
        int total_images = 0;

        std::vector<Tensor> batch_images;

        // Vòng lặp qua các Batch
        while (dataset.get_next_batch(BATCH_SIZE, batch_images))
        {
            float batch_loss = 0.0f;

            // Xử lý từng ảnh trong Batch (Do CPU chạy tuần tự)
            for (const auto &img : batch_images)
            {
                Tensor output;

                // a. Forward pass [cite: 264]
                model.forward(img, output);

                // b. Compute Loss [cite: 265]
                float loss = model.compute_loss(img, output);
                batch_loss += loss;

                // c. Backward pass & Update weights [cite: 265]
                // Lưu ý: Trong phiên bản CPU cơ bản này, weights được update ngay lập tức (SGD)
                model.backward(img, output, LEARNING_RATE);
            }

            total_epoch_loss += batch_loss;
            total_images += batch_images.size();

            // In tiến độ (Progress bar đơn giản) nếu cần
            // if (total_images % (BATCH_SIZE * 10) == 0) std::cout << "." << std::flush;
        }

        // Kết thúc bấm giờ
        auto end_time = std::chrono::high_resolution_clock::now();
        std::chrono::duration<double> elapsed = end_time - start_time;

        // Tính toán các chỉ số
        float avg_loss = total_epoch_loss / total_images;
        float img_per_sec = total_images / elapsed.count();

         // Hiển thị kết quả Epoch [cite: 266-267]
            std::cout
            << "|  " << std::setw(3) << (epoch + 1) << "  | "
            << std::fixed << std::setprecision(6) << avg_loss << " | "
            << std::setw(9) << std::setprecision(2) << elapsed.count() << "s | "
            << std::setw(10) << img_per_sec << " |" << std::endl;
    }
    std::cout << "------------------------------------------------------------" << std::endl;

    // --- 5. SAVE TRAINED MODEL [cite: 268] ---
        std::cout
        << "[4/4] Saving trained weights..." << std::endl;
    std::string model_path = "models/cifar10_ae_cpu.bin";
    model.save_weights(model_path);

    std::cout << "      Model saved to: " << model_path << std::endl;
    std::cout << "Phase 1 Completed Successfully!" << std::endl;

    return 0;
}